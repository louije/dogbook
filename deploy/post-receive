#!/bin/bash
# Git post-receive hook for dogbook deployment
# This runs automatically after 'git push deploy main'

set -e

# Load nvm
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

TARGET="/srv/dogbook/current"
GIT_DIR="/srv/dogbook/repo.git"
BRANCH="main"

while read oldrev newrev ref
do
    # Only deploy if pushing to main branch
    if [[ $ref = "refs/heads/$BRANCH" ]]; then
        echo "======================================"
        echo "Deploying dogbook backend to production"
        echo "======================================"

        # Checkout latest code
        echo "→ Checking out code..."
        git --work-tree=$TARGET --git-dir=$GIT_DIR checkout -f $BRANCH

        # Fix ownership for build (files may be owned by caddy from service)
        echo "→ Fixing file ownership for build..."
        sudo chown -R deploy-user:deploy-user $TARGET

        # Navigate to backend directory
        cd $TARGET/backend

        # Install dependencies (skip postinstall to avoid schema check)
        echo "→ Installing dependencies..."
        npm install --production --ignore-scripts

        # Fix Prisma binary targets for production server
        echo "→ Updating Prisma binary targets..."
        sed -i 's/provider = "prisma-client-js"/provider = "prisma-client-js"\n  binaryTargets = ["native", "debian-openssl-3.0.x"]/' schema.prisma

        # Generate Prisma client
        echo "→ Generating Prisma client..."
        npx prisma generate

        # Stop service before migrations (SQLite locks)
        echo "→ Stopping service for migrations..."
        sudo systemctl stop dogbook || true

        # Run database migrations
        echo "→ Running database migrations..."
        npx prisma migrate deploy

        # Build backend
        echo "→ Building backend..."
        npm run build

        # Ensure data symlink exists
        if [ ! -L "$TARGET/data" ]; then
            echo "→ Creating data symlink..."
            ln -s /srv/dogbook/data $TARGET/data
        fi

        # Restore ownership to caddy for service
        echo "→ Restoring file ownership to caddy..."
        sudo chown -R caddy:caddy $TARGET

        # Restart systemd service
        echo "→ Restarting dogbook service..."
        if sudo systemctl restart dogbook 2>&1; then
            echo "✓ Service restarted successfully"
        else
            echo "⚠ Warning: Failed to restart service (exit code: $?)"
            echo "  You may need to restart manually: sudo systemctl restart dogbook"
        fi

        echo "======================================"
        echo "✓ Deployment complete!"
        echo "======================================"
    fi
done
